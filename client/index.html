<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<title>Go</title>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
		<script src="port.js"></script>
		<script src="connection.js"></script>
		<script src="vector.js"></script>
		<script src="graphics.js"></script>
		<script src="game.js"></script>
		<script src="cursor.js"></script>
		<link rel="stylesheet" href="style.css" />
	</head>
	<body>
		<h1>Coole Überschrift</h1>
		<div id="content">
			Bitte aktivieren Sie JavaScript in Ihrem Browser, um diese Seite richtig darzustellen. 
			Eigentlich sollten Sie hier Go spielen können...
		</div>
		<script>
			var opponent;
			var my_name;
			
			function showTemplate(template, handler){
				$.ajax({
					url: "templates/" + template + ".html",
					success: function(html) {
						$("#content").html("");
						var node = $(html);
						node.appendTo($("#content"));
						if(handler !== undefined) {
							handler($("#content"));
						}
					}
				});
			}
			
			function showPopUp(message){
				alert(message);
			}
			
			function showConfirmPopUp(message, yes, no, clickHandler){
				var div = $('<div>' + message + "</div>");
					div.append($("<button>" + yes + "</button>").click(function(){
							div.remove();
							clickHandler(true);
						}))
					.append($("<button>" + no + "</button>").click(function(){
							div.remove();
							clickHandler(false);
						}))
					.appendTo($("body"));
			}
			
			$(function(){
				showTemplate("loading");
				console.log("Hello");
				Connection.init();
				Connection.addMessageListener("setName", function(data){
					my_name = data;
					showTemplate("start", function(node) {
						node.find("#my_name").html("Mein Name: " + data.substring(0,1).toUpperCase() + data.substring(1, data.length).toLowerCase());
						var name = node.find("#other_name");
						node.find("#challenge").click(function(){
							challenge(name.val().toUpperCase());
						});
						node.find("#other_name").keyup(function(evt){
							if(evt.which == 13){
								challenge(name.val().toUpperCase());
							}
						});
					});
				});
				Connection.addMessageListener("matchRequest", function(name, answer){
					if(opponent !== undefined){
						answer(false);
					}
					else{
						showConfirmPopUp(name + " hat dich herausgefordert. Möchtest du die Herausforderung annehmen?", "Ja", "Nein", function(yes){
							if(yes){
								opponent = name;
							}
							answer(yes);
						});
					}
				}, true);
				Connection.addMessageListener("matchDeclined", function(reason){
					opponent = undefined;
					showPopUp(reason);
				});
				Connection.addMessageListener("matchAccepted", function(challenger, answer){
					showTemplate("game", function(node){
						node.find("#challenger").html(challenger);
						var opp = my_name;
						if(challenger == my_name){
							opp = opponent;
						}
						node.find("#opponent").html(opp);
						startGame();
						answer();
					});
				}, true);
				Connection.addMessageListener("nextTurn", function(name){
					var challenger = $("#challenger").html();
					console.log("Challenger: " + challenger);
					if(challenger == name){
						$("#challenger").css({"color": "red"});
						$("#opponent").css({"color": "black"});
					}
					else{
						$("#challenger").css({"color": "black"});
						$("#opponent").css({"color": "red"});
					}
				});
				Connection.addMessageListener("madeTurn", function(pos){
					Game.place(pos.row, pos.col);
				});
			});
		</script>
	</body>
</html>
